<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book Marketplace Demo</title>

<!-- Ethers + MetaMask + Alpine -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.5.3/dist/ethers.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider@1.2.0/dist/detect-provider.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.8.1/dist/cdn.min.js" defer></script>
<script src="abismart.js" defer></script>
<script src="abitoken.js" defer></script>

<style>
  body { font-family: sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  table th, table td { border: 1px solid #ddd; padding: 6px 10px; text-align: center; }
  input { margin: 4px; padding: 6px; width: 250px; }
  button { padding: 6px 12px; cursor: pointer; }
  img { border-radius: 6px; }
</style>
</head>
<body>

<div x-data="{
  isConnected: false,
  ethereum: null,
  account: '',

  tokenAddress: '0x30b32EE29623350E94206Ce0f83483E5cAF69416',      // NWN token address
  marketplaceAddress: '0xe18c143194ac22BB9aDb518f4EF969294131dc0c', // Marketplace contract address

  balance: ethers.BigNumber.from(0),
  mytokenBalance: ethers.BigNumber.from(0),

  bookTitle: '',
  bookImage: '',
  bookPrice: '',

  books: [],

  async init() {
    this.ethereum = await detectEthereumProvider();
    if (!this.ethereum) return alert('MetaMask not found');
    window.provider = new ethers.providers.Web3Provider(this.ethereum);

    const detectAccount = async () => {
      const accounts = await this.ethereum.request({ method: 'eth_accounts' });
      if (!accounts.length) { this.isConnected = false; return; }
      this.account = accounts[0];
      this.isConnected = true;
      await this.reloadBalance();
      await this.reloadMyTokenBalance();
      await this.loadBooks();
    }
    detectAccount();
    this.ethereum.on('accountsChanged', detectAccount);

    setInterval(() => {
      this.reloadBalance();
      this.reloadMyTokenBalance();
      this.loadBooks();
    }, 5000);
  },

  async connect() {
    await this.ethereum.request({ method: 'eth_requestAccounts' });
  },

  async reloadBalance() {
    this.balance = await window.provider.getBalance(this.account);
  },

  async reloadMyTokenBalance() {
    const token = new ethers.Contract(this.tokenAddress, abi.IERC20, window.provider);
    this.mytokenBalance = await token.balanceOf(this.account);
  },

  async listBook() {
    const marketplace = new ethers.Contract(this.marketplaceAddress, abi.IMarketplace, window.provider);
    const signer = window.provider.getSigner();
    const tx = await marketplace.connect(signer).listBook(this.bookTitle, this.bookImage, ethers.utils.parseEther(this.bookPrice));
    await tx.wait();
    this.bookTitle = '';
    this.bookImage = '';
    this.bookPrice = '';
    await this.loadBooks();
    alert('Book listed!');
  },

  async buyBook(id) {
    const marketplace = new ethers.Contract(this.marketplaceAddress, abi.IMarketplace, window.provider);
    const signer = window.provider.getSigner();
    const tx = await marketplace.connect(signer).buyBook(id);
    await tx.wait();
    await this.loadBooks();
    alert('Book bought!');
  },

  async loadBooks() {
    const marketplace = new ethers.Contract(this.marketplaceAddress, abi.IMarketplace, window.provider);
    const total = await marketplace.nextBookId();
    const arr = [];
    for (let i = 0; i < total; i++) {
      const b = await marketplace.books(i);
      arr.push(b);
    }
    this.books = arr;
  }

}" x-init="init()">

<!-- CONNECT -->
<button x-show="!isConnected" @click="connect">Connect Wallet</button>

<!-- WALLET INFO -->
<div x-show="isConnected">
<h2>Account: <span x-text="account"></span></h2>
<p>ETH Balance: <span x-text="ethers.utils.formatEther(balance)"></span></p>
<p>NWN Token Balance: <span x-text="ethers.utils.formatEther(mytokenBalance)"></span></p>

<!-- LIST BOOK -->
<hr>
<h3>List a New Book</h3>
<input x-model="bookTitle" placeholder="Book Title">
<input x-model="bookImage" placeholder="Book Image URL">
<input x-model="bookPrice" placeholder="Price in NWN">
<button @click="listBook">List Book</button>

<!-- AVAILABLE BOOKS -->
<hr>
<h3>Available Books</h3>
<table>
<thead>
<tr>
<th>ID</th><th>Cover</th><th>Title</th><th>Seller</th><th>Price</th><th>Sold</th><th>Action</th>
</tr>
</thead>
<tbody>
<template x-for="book in books" :key="book.id">
<tr>
<td x-text="book.id"></td>
<td><img :src="book.imageURL" width="70"></td>
<td x-text="book.title"></td>
<td x-text="book.seller"></td>
<td x-text="ethers.utils.formatEther(book.price)"></td>
<td x-text="book.sold ? 'Yes' : 'No'"></td>
<td><button x-show="!book.sold" @click="buyBook(book.id)">Buy</button></td>
</tr>
</template>
</tbody>
</table>

</div>
</div>

</body>
</html>
